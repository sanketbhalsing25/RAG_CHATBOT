# azure-pipelines.yml
trigger:
  branches:
    include:
      - main  # CI triggers on push to main branch

variables:
  # Azure settings
  azureSubscription: 'Your-Azure-Subscription-Name'
  azureContainerRegistry: 'youracr.azurecr.io'
  imageName: 'medical-rag-chatbot'
  tag: '$(Build.BuildId)'

  # Python version
  pythonVersion: '3.11'

stages:
- stage: Build
  displayName: 'Build & Test'
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    # Checkout code
    - task: Checkout@1

    # Set up Python
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'

    # Install dependencies
    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install Python dependencies'

    # Optional: Run tests
    #- script: |
    #    pytest tests/
    #  displayName: 'Run tests'

    # Build Docker image
    - task: Docker@2
      displayName: 'Build Docker image'
      inputs:
        command: 'build'
        repository: '$(azureContainerRegistry)/$(imageName)'
        Dockerfile: '**/Dockerfile'
        tags: |
          $(tag)

    # Push Docker image to ACR
    - task: Docker@2
      displayName: 'Push Docker image'
      inputs:
        command: 'push'
        repository: '$(azureContainerRegistry)/$(imageName)'
        tags: |
          $(tag)

- stage: Deploy
  displayName: 'Deploy to Azure'
  dependsOn: Build
  jobs:
  - deployment: DeployToAppService
    displayName: 'Deploy to Azure App Service'
    environment: 'production'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebAppContainer@2
            displayName: 'Deploy Docker image to Azure App Service'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: 'your-app-service-name'
              containers: |
                $(azureContainerRegistry)/$(imageName):$(tag)
